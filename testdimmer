// ==UserScript==
// @name         Pro Smart Dimmer (Toggle + Auto)
// @version      1.3
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // 1. CSS for UI and Effects
    const style = document.createElement('style');
    style.innerHTML = `
        html { transition: filter 0.5s ease-in-out !important; }
        html.is-dimmed { filter: brightness(0.8) contrast(1.1) !important; }
        html.is-dimmed img, html.is-dimmed video { filter: brightness(1.2) contrast(0.9) !important; }

        #dimmer-toggle {
            position: fixed; bottom: 20px; right: 20px; z-index: 999999;
            width: 40px; height: 40px; border-radius: 50%;
            background: #333; color: white; border: 2px solid #555;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 20px; opacity: 0.5; transition: opacity 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); user-select: none;
        }
        #dimmer-toggle:hover { opacity: 1; }
        #dimmer-toggle.active { background: #ffcc00; color: #000; border-color: #fff; }
    `;
    document.head.appendChild(style);

    // 2. State Management
    const siteKey = `dimmer_off_${window.location.host}`;
    let manualDisabled = localStorage.getItem(siteKey) === 'true';

    // 3. Create Toggle Button
    const btn = document.createElement('div');
    btn.id = 'dimmer-toggle';
    btn.innerHTML = 'ðŸ’¡';
    btn.title = 'Toggle Smart Dimmer';
    document.body.appendChild(btn);

    function updateDimmer(forceState = null) {
        const bgColor = window.getComputedStyle(document.body).backgroundColor;
        const rgb = bgColor.match(/\d+/g);
        let isBright = false;

        if (rgb && rgb.length >= 3) {
            const l = (0.2126 * rgb[0] + 0.7152 * rgb[1] + 0.0722 * rgb[2]) / 255;
            isBright = l > 0.82;
        }

        const shouldDim = forceState !== null ? forceState : (isBright && !manualDisabled);
        
        if (shouldDim) {
            document.documentElement.classList.add('is-dimmed');
            btn.classList.add('active');
        } else {
            document.documentElement.classList.remove('is-dimmed');
            btn.classList.remove('active');
        }
    }

    // 4. Button Logic
    btn.onclick = () => {
        manualDisabled = !manualDisabled;
        localStorage.setItem(siteKey, manualDisabled);
        updateDimmer(!manualDisabled); // Toggle based on new manual state
    };

    // 5. Observer for Dynamic Changes
    const observer = new MutationObserver(() => updateDimmer());
    observer.observe(document.body, { attributes: true, attributeFilter: ['style', 'class'] });

    // Initial Run
    updateDimmer();
})();
