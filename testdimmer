// ==UserScript==
// @name         Robust Smart Dimmer
// @version      1.4
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    const style = document.createElement('style');
    style.innerHTML = `
        html { transition: filter 0.4s ease-in-out !important; }
        html.is-dimmed { filter: brightness(0.8) contrast(1.1) !important; background-color: #121212 !important; }
        html.is-dimmed img, html.is-dimmed video { filter: brightness(1.2) contrast(0.9) !important; }
        #dimmer-toggle {
            position: fixed; bottom: 20px; right: 20px; z-index: 2147483647;
            width: 40px; height: 40px; border-radius: 50%;
            background: #333; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; border: 2px solid #555; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        #dimmer-toggle.manual-on { background: #ffcc00; color: #000; }
        #dimmer-toggle.manual-off { background: #555; color: #aaa; }
    `;
    document.head.appendChild(style);

    const siteKey = `dimmer_mode_${window.location.host}`; 
    // Modes: null (auto), "force-on", "force-off"
    let userMode = localStorage.getItem(siteKey); 

    const btn = document.createElement('div');
    btn.id = 'dimmer-toggle';
    btn.innerHTML = 'ðŸ’¡';
    document.body.appendChild(btn);

    function getLuminance(el) {
        if (!el) return 0;
        const color = window.getComputedStyle(el).backgroundColor;
        const rgb = color.match(/\d+/g);
        if (!rgb || rgb.length < 3) return 0;
        return (0.2126 * rgb[0] + 0.7152 * rgb[1] + 0.0722 * rgb[2]) / 255;
    }

    function applyLogic() {
        // 1. Priority: Manual Override
        if (userMode === "force-on") {
            document.documentElement.classList.add('is-dimmed');
            btn.className = 'manual-on';
            return;
        }
        if (userMode === "force-off") {
            document.documentElement.classList.remove('is-dimmed');
            btn.className = 'manual-off';
            return;
        }

        // 2. Auto-Detection Logic
        const bodyLum = getLuminance(document.body);
        const docLum = getLuminance(document.documentElement);
        const isBright = bodyLum > 0.8 || docLum > 0.8;

        if (isBright) {
            document.documentElement.classList.add('is-dimmed');
            btn.className = ''; // Default auto look
        } else {
            document.documentElement.classList.remove('is-dimmed');
            btn.className = '';
        }
    }

    btn.onclick = () => {
        if (userMode === "force-on") userMode = "force-off";
        else if (userMode === "force-off") userMode = null;
        else userMode = "force-on"; // Cycle: Auto -> On -> Off

        localStorage.setItem(siteKey, userMode);
        applyLogic();
    };

    // Fix for "Undo on Scroll": We use a debounce to prevent infinite loops
    const observer = new MutationObserver(() => applyLogic());
    observer.observe(document.body, { attributes: true, attributeFilter: ['style', 'class'] });

    // Fix for "Initial Load": Check multiple times as the page loads
    applyLogic();
    const loadCheck = setInterval(applyLogic, 500);
    setTimeout(() => clearInterval(loadCheck), 4000); // Stop checking after 4s
})();
