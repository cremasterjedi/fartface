// ==UserScript==
// @name         Non-Destructive Smart Dimmer
// @version      1.6
// @match        *://*/*
// @run-at       document-start
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    const siteKey = `dimmer_pref_${window.location.host}`;
    let userPref = localStorage.getItem(siteKey) || 'auto'; 

    // Create a style element that we will update dynamically
    const styleEl = document.createElement('style');
    styleEl.id = 'smart-dimmer-styles';
    
    // We append to documentElement immediately so it exists before the body
    document.documentElement.appendChild(styleEl);

    function getLuminance() {
        // We check the computed style of the body or document
        const target = document.body || document.documentElement;
        const color = window.getComputedStyle(target).backgroundColor;
        
        // If the background is transparent (rgba 0,0,0,0), it defaults to white on most browsers
        if (color === 'rgba(0, 0, 0, 0)' || color === 'transparent') return 1;

        const rgb = color.match(/\d+/g);
        if (rgb && rgb.length >= 3) {
            return (0.2126 * rgb[0] + 0.7152 * rgb[1] + 0.0722 * rgb[2]) / 255;
        }
        return 1; // Default to bright if we can't tell
    }

    function update() {
        const isBright = getLuminance() > 0.82;
        const shouldDim = (userPref === 'on') || (userPref === 'auto' && isBright);

        // We ONLY use filters here. No 'background-color' overrides.
        const filterVal = shouldDim ? 'brightness(0.8) contrast(1.1)' : 'none';
        const mediaFilter = shouldDim ? 'brightness(1.2) contrast(0.9)' : 'none';

        styleEl.innerHTML = `
            html { 
                filter: ${filterVal} !important; 
                transition: filter 0.4s ease !important;
                /* Removed background-color override that caused blackouts */
            }
            img, video, canvas, [style*="background-image"] { 
                filter: ${mediaFilter} !important; 
            }
            #dimmer-ui {
                position: fixed; bottom: 20px; right: 20px; z-index: 2147483647;
                width: 44px; height: 44px; border-radius: 50%;
                background: ${userPref === 'on' ? '#ffcc00' : '#333'};
                border: 2px solid white; cursor: pointer;
                display: flex; align-items: center; justify-content: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5); font-size: 20px;
                transition: background 0.3s;
            }
        `;
    }

    // Toggle logic
    const toggle = (e) => {
        e.stopPropagation();
        if (userPref === 'auto') userPref = 'on';
        else if (userPref === 'on') userPref = 'off';
        else userPref = 'auto';
        
        localStorage.setItem(siteKey, userPref);
        update();
    };

    // Initialize UI and Observer
    const init = () => {
        if (!document.getElementById('dimmer-ui')) {
            const btn = document.createElement('div');
            btn.id = 'dimmer-ui';
            btn.innerHTML = 'ðŸ’¡';
            btn.addEventListener('click', toggle);
            document.body.appendChild(btn);
        }
        update();
    };

    // Monitor for changes (fixes the "Undo on scroll" issue)
    const observer = new MutationObserver(() => update());
    
    if (document.readyState === 'loading') {
        window.addEventListener('DOMContentLoaded', () => {
            init();
            observer.observe(document.documentElement, { attributes: true, subtree: true, attributeFilter: ['style', 'class'] });
        });
    } else {
        init();
        observer.observe(document.documentElement, { attributes: true, subtree: true, attributeFilter: ['style', 'class'] });
    }

    // Final fallback check for slow-loading themes
    setTimeout(update, 1000);
    setTimeout(update, 3000);
})();
